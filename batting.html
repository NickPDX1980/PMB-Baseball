<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batting Stats - Parkrose MS Baseball</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <h1>Batting Statistics</h1>

    <div class="table-container">
        <table>
            <thead id="batting-thead"></thead>
            <tbody id="batting-tbody">
                <tr><td>Loading stats...</td></tr>
            </tbody>
            <tfoot id="batting-tfoot"></tfoot>
        </table>
    </div>
    <div id="error-container"></div>

    <div id="header-key-container">
        </div>

    <a href="index.html" class="nav-link">&laquo; Back to Home</a>

    <script>
        // --- Header Definitions ---
        // Add all expected batting headers and their definitions here
        const headerDefs = {
            "GP": "Games Played",
            "PA": "Plate Appearances",
            "AB": "At Bats",
            "R": "Runs Scored",
            "H": "Hits",
            "1B": "Singles",
            "2B": "Doubles",
            "3B": "Triples",
            "HR": "Home Runs",
            "RBI": "Runs Batted In",
            "BB": "Base on Balls (Walks)",
            "SO": "Strikeouts",
            "K": "Strikeouts", // Allow 'K' as alternative for SO
            "SB": "Stolen Bases",
            "CS": "Caught Stealing",
            "AVG": "Batting Average (H/AB)",
            "OBP": "On-Base Percentage",
            "SLG": "Slugging Percentage",
            "OPS": "On-Base Plus Slugging"
            // Add more as needed based on your CSV
        };

        // --- Helper function to remove leading/trailing quotes ---
        function stripQuotes(str) { if (typeof str !== 'string') return str; const trimmed = str.trim(); if (trimmed.length >= 2 && trimmed.startsWith('"') && trimmed.endsWith('"')) { return trimmed.substring(1, trimmed.length - 1); } return trimmed; }

        // --- Sorting Function ---
        function sortTable(columnIndex, tbodyId, clickedThElement) { const tbody = document.getElementById(tbodyId); const rowsArray = Array.from(tbody.querySelectorAll('tr')); if (rowsArray.length <= 1) return; const currentDirection = clickedThElement.dataset.sortDirection || 'none'; let newDirection = (currentDirection === 'ascending') ? 'descending' : 'ascending'; const allHeaders = clickedThElement.closest('thead').querySelectorAll('th'); allHeaders.forEach(th => { if (th !== clickedThElement) { delete th.dataset.sortDirection; th.classList.remove('sort-asc', 'sort-desc'); } }); clickedThElement.dataset.sortDirection = newDirection; clickedThElement.classList.remove('sort-asc', 'sort-desc'); clickedThElement.classList.add(newDirection === 'ascending' ? 'sort-asc' : 'sort-desc'); const firstDataCell = rowsArray[0]?.querySelectorAll('td')[columnIndex]; const rawSampleValue = firstDataCell ? firstDataCell.textContent : ''; const sampleValue = stripQuotes(rawSampleValue); const isNumeric = sampleValue !== '' && !isNaN(parseFloat(sampleValue)); console.log(`Sorting column ${columnIndex} as ${isNumeric ? 'Numeric' : 'Text'}`); rowsArray.sort((rowA, rowB) => { const cellA = rowA.querySelectorAll('td')[columnIndex]; const cellB = rowB.querySelectorAll('td')[columnIndex]; const valueA = stripQuotes(cellA ? cellA.textContent : ''); const valueB = stripQuotes(cellB ? cellB.textContent : ''); let comparison = 0; if (isNumeric) { const numA = parseFloat(valueA); const numB = parseFloat(valueB); if (isNaN(numA) && isNaN(numB)) comparison = 0; else if (isNaN(numA)) comparison = 1; else if (isNaN(numB)) comparison = -1; else comparison = numA - numB; } else { comparison = valueA.localeCompare(valueB); } return (newDirection === 'ascending') ? comparison : (comparison * -1); }); const fragment = document.createDocumentFragment(); rowsArray.forEach(row => fragment.appendChild(row)); tbody.innerHTML = ''; tbody.appendChild(fragment); console.log(`Table sorted by column ${columnIndex}, direction: ${newDirection}`); }

        // --- Load CSV Data Function (UPDATED for Header Key) ---
        async function loadCsvData(csvFilename, theadId, tbodyId, tfootId, errorContainerId, keyContainerId) { // Added keyContainerId
            const thead = document.getElementById(theadId);
            const tbody = document.getElementById(tbodyId);
            const tfoot = document.getElementById(tfootId);
            const errorContainer = document.getElementById(errorContainerId);
            const keyContainer = document.getElementById(keyContainerId); // Get key container

            // Clear previous content
            thead.innerHTML = ''; tbody.innerHTML = '<tr><td>Loading stats...</td></tr>'; tfoot.innerHTML = ''; errorContainer.innerHTML = ''; keyContainer.innerHTML = ''; // Clear key container

            try {
                const response = await fetch(csvFilename);
                if (!response.ok) throw new Error(`Network error: ${response.statusText} (${response.status})`);
                const csvData = await response.text();
                const lines = csvData.trim().split(/\r?\n/);
                if (lines.length < 2) { tbody.innerHTML = '<tr><td>CSV file empty or missing headers/data.</td></tr>'; return; }

                // --- Process Header & Build Key ---
                const headerValues = lines[0].split(',');
                const numColumns = headerValues.length;
                const headerRow = document.createElement('tr');
                const keyList = document.createElement('ul'); // Create list for the key

                headerValues.forEach((headerText, index) => {
                    const th = document.createElement('th');
                    const cleanHeaderText = stripQuotes(headerText); // Use cleaned header for lookup
                    th.textContent = cleanHeaderText;
                    th.dataset.columnIndex = index;

                    // Look up definition and set title (tooltip) + add to key list
                    const definition = headerDefs[cleanHeaderText.toUpperCase()]; // Use uppercase for case-insensitive lookup
                    if (definition) {
                        th.title = definition; // Set tooltip
                        const keyItem = document.createElement('li');
                        keyItem.innerHTML = `<strong>${cleanHeaderText}:</strong> ${definition}`;
                        keyList.appendChild(keyItem);
                    } else {
                        th.title = `Click to sort by ${cleanHeaderText}`; // Default title
                        console.warn(`No definition found for header: ${cleanHeaderText}`);
                    }

                    th.addEventListener('click', (event) => { sortTable(index, tbodyId, event.currentTarget); });
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                console.log(`Processed header: ${numColumns} columns.`);

                // Add Key Title and List to the container (only if items were found)
                if (keyList.children.length > 0) {
                     const keyTitle = document.createElement('h2');
                     keyTitle.textContent = 'Header Key';
                     keyContainer.appendChild(keyTitle);
                     keyContainer.appendChild(keyList);
                }

                // --- Process Data Rows (excluding last 2) ---
                tbody.innerHTML = ''; // Clear "Loading..."
                const dataEndIndex = lines.length - 2;
                let dataRowsProcessed = 0;
                if (dataEndIndex >= 1) {
                    for (let i = 1; i < dataEndIndex; i++) {
                        if (lines[i].trim() === '') continue;
                        const dataValues = lines[i].split(',');
                        const dataRow = document.createElement('tr');
                        for (let j = 0; j < numColumns; j++) {
                            const td = document.createElement('td');
                            td.textContent = stripQuotes(dataValues[j]);
                            dataRow.appendChild(td);
                        }
                        tbody.appendChild(dataRow);
                        dataRowsProcessed++;
                    }
                }
                console.log(`Processed ${dataRowsProcessed} data rows into tbody.`);

                 // --- Process Footer Rows (Last 2 lines) ---
                 if (lines.length >= dataEndIndex) {
                    for (let i = Math.max(1, dataEndIndex); i < lines.length; i++) {
                         if (lines[i].trim() === '') {
                             const blankRow = document.createElement('tr');
                             const blankTd = document.createElement('td');
                             blankTd.colSpan = numColumns; blankTd.innerHTML = '&nbsp;';
                             blankRow.appendChild(blankTd);
                             tfoot.appendChild(blankRow);
                             continue;
                         }
                         const footerValues = lines[i].split(',');
                         const footerRow = document.createElement('tr');
                         for (let j = 0; j < numColumns; j++) {
                             const td = document.createElement('td');
                             td.textContent = stripQuotes(footerValues[j]);
                             footerRow.appendChild(td);
                         }
                         tfoot.appendChild(footerRow);
                    }
                    console.log(`Processed remaining ${lines.length - Math.max(1, dataEndIndex)} lines into tfoot.`);
                 }

            } catch (error) {
                console.error(`Error loading/parsing CSV (${csvFilename}):`, error);
                thead.innerHTML = ''; tbody.innerHTML = ''; tfoot.innerHTML = ''; keyContainer.innerHTML = ''; // Clear all
                errorContainer.innerHTML = `<p class="error-message">Error loading stats: ${error.message}</p>`;
            }
        }

        // --- Initial Load Trigger (UPDATED for Key Container) ---
        document.addEventListener('DOMContentLoaded', () => {
            loadCsvData('batting stats.csv', 'batting-thead', 'batting-tbody', 'batting-tfoot', 'error-container', 'header-key-container');
        });
    </script>

</body>
</html>